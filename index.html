<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Generator - Real Payments - UPDATED - WORKING NOW!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- FORCE UPDATE: 2024-12-19 15:45:00 - WORKING NOW! -->
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 50%, #fbbf24 100%);
        }
        .btn-primary {
            background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.3s;
            transform: scale(1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #fce7f3;
            border-radius: 8px;
            outline: none;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.9);
        }
        .input-field:focus {
            ring: 2px;
            ring-color: #ec4899;
            border-color: transparent;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid #fce7f3;
        }
        .recipe-card {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Recipe Generator - Real Payments - WORKING NOW!</h1>
            <p class="text-gray-600">Enter your ingredients and get delicious recipes!</p>
            <p class="text-sm text-red-600 mt-2">‚ö†Ô∏è Updated with Real Payment Processing - WORKING NOW!</p>
            <p class="text-lg font-bold text-green-600 mt-2">üöÄ SITE IS UPDATED AND WORKING!</p>
            <div style="background: red; color: white; padding: 20px; margin: 20px; border: 5px solid yellow; font-size: 24px; font-weight: bold;">
                üî• THIS IS A TEST - IF YOU SEE THIS RED BOX, THE SITE IS UPDATED! üî•
            </div>
            
            <!-- Premium Banner -->
            <div id="premium-banner" class="card p-4 mt-4 bg-gradient-to-r from-yellow-100 to-orange-100 border-2 border-yellow-200">
                <div class="flex items-center justify-center gap-4">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">Upgrade to Premium</h3>
                        <p class="text-sm text-gray-600">Unlock advanced features and unlimited recipes!</p>
                    </div>
                    <button onclick="showPremiumModal()" class="btn-primary px-4 py-2 text-sm">
                        Upgrade Now
                    </button>
                </div>
                <!-- Debug button for testing -->
                <div class="text-center mt-2">
                    <button onclick="testPremiumModal()" class="text-xs bg-blue-500 text-white px-2 py-1 rounded">
                        Test Modal
            </button>
                    <button onclick="unlockPremiumForTesting()" class="text-xs bg-green-500 text-white px-2 py-1 rounded ml-2">
                        Unlock Premium (Test)
                        </button>
                    <button onclick="testPayment()" class="text-xs bg-red-500 text-white px-2 py-1 rounded ml-2">
                        Test Payment
            </button>
                        </div>
                    </div>

                    <!-- Input Form -->
                    <div class="card p-6 mb-6">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">Ingredients:</label>
                            <div id="ingredients-container">
                                <div class="flex gap-2 mb-2">
                                    <input type="text" class="input-field flex-1" placeholder="Enter an ingredient..." id="ingredient-0">
                                    <button onclick="addIngredient()" class="btn-primary">+</button>
                <button onclick="removeIngredient(this)" class="btn-primary">-</button>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">Dietary Restrictions:</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2" value="vegetarian"> Vegetarian
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2" value="vegan"> Vegan
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2" value="gluten-free"> Gluten-Free
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2" value="dairy-free"> Dairy-Free
                                </label>
                            </div>
                        </div>

                        <!-- Premium Features -->
            <div id="premium-features" class="mb-4 hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">üéâ Premium Features Unlocked!</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Servings:</label>
                        <select id="servings-select" class="input-field">
                                <option value="2">2 servings</option>
                                <option value="4" selected>4 servings</option>
                                <option value="6">6 servings</option>
                                <option value="8">8 servings</option>
                                <option value="10">10 servings</option>
                                <option value="12">12 servings (Party)</option>
                            </select>
                        </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Cooking Time:</label>
                        <select id="time-select" class="input-field">
                                <option value="any">Any time</option>
                                <option value="quick">Quick (15 min or less)</option>
                                <option value="medium">Medium (15-30 min)</option>
                                <option value="slow">Slow (30+ min)</option>
                                <option value="overnight">Overnight (Slow cooker)</option>
                            </select>
                        </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Cuisine Style:</label>
                        <select id="cuisine-select" class="input-field">
                                <option value="any">Any cuisine</option>
                                <option value="italian">Italian</option>
                                <option value="asian">Asian</option>
                                <option value="mexican">Mexican</option>
                                <option value="mediterranean">Mediterranean</option>
                                <option value="indian">Indian</option>
                                <option value="american">American</option>
                                <option value="french">French</option>
                                <option value="thai">Thai</option>
                                <option value="greek">Greek</option>
                                <option value="japanese">Japanese</option>
                                <option value="chinese">Chinese</option>
                                <option value="spanish">Spanish</option>
                                <option value="moroccan">Moroccan</option>
                            </select>
                        </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Difficulty Level:</label>
                        <select id="difficulty-select" class="input-field">
                                <option value="any">Any difficulty</option>
                                <option value="easy">Easy (Beginner)</option>
                                <option value="medium">Medium (Intermediate)</option>
                                <option value="hard">Hard (Advanced)</option>
                                <option value="expert">Expert (Chef level)</option>
                            </select>
                        </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Cooking Method:</label>
                        <select id="method-select" class="input-field">
                                <option value="any">Any method</option>
                                <option value="stovetop">Stovetop</option>
                                <option value="oven">Oven/Baking</option>
                                <option value="grill">Grill/BBQ</option>
                                <option value="slow-cooker">Slow Cooker</option>
                                <option value="instant-pot">Instant Pot</option>
                                <option value="air-fryer">Air Fryer</option>
                                <option value="microwave">Microwave</option>
                                <option value="raw">Raw/No Cook</option>
                            </select>
                            </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Spice Level:</label>
                        <select id="spice-select" class="input-field">
                                <option value="any">Any spice level</option>
                                <option value="mild">Mild</option>
                                <option value="medium">Medium</option>
                                <option value="hot">Hot</option>
                                <option value="extra-hot">Extra Hot</option>
                                <option value="custom">Custom (Adjustable)</option>
                            </select>
                        </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Nutrition Focus:</label>
                        <select id="nutrition-select" class="input-field">
                                <option value="any">Any nutrition</option>
                                <option value="low-calorie">Low Calorie</option>
                                <option value="high-protein">High Protein</option>
                                <option value="low-carb">Low Carb</option>
                                <option value="keto">Keto</option>
                                <option value="paleo">Paleo</option>
                                <option value="heart-healthy">Heart Healthy</option>
                                <option value="diabetic-friendly">Diabetic Friendly</option>
                                <option value="gluten-free">Gluten Free</option>
                                <option value="dairy-free">Dairy Free</option>
                            </select>
                            </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Budget Level:</label>
                        <select id="budget-select" class="input-field">
                                <option value="any">Any budget</option>
                                <option value="budget">Budget Friendly</option>
                                <option value="moderate">Moderate</option>
                                <option value="premium">Premium Ingredients</option>
                                <option value="luxury">Luxury/High End</option>
                            </select>
                        </div>
                            </div>
                <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                    <p class="text-sm text-green-700">‚úÖ Premium features are now active! You can customize your recipes with advanced options.</p>
                    <p class="text-sm text-blue-700 mt-1">üåü New features: Cooking Method, Spice Level, Nutrition Focus, Budget Level!</p>
                            </div>
                        </div>

                        <button onclick="generateRecipe()" class="btn-primary w-full py-3">
                            Generate Recipe
                        </button>
                    </div>

                    <!-- Recipe Display -->
                    <div id="recipe-display" class="hidden">
                        <div class="card p-8 recipe-card">
                            <h2 id="recipe-title" class="text-3xl font-bold text-gray-800 mb-4"></h2>
                            <p id="recipe-description" class="text-gray-600 mb-6"></p>
                            
                            <div class="grid md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Ingredients:</h3>
                                    <ul id="recipe-ingredients" class="space-y-2"></ul>
                                </div>
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Instructions:</h3>
                                    <ol id="recipe-instructions" class="space-y-3"></ol>
                                </div>
                            </div>

                <div class="flex flex-wrap gap-4 text-sm text-gray-600 mb-6">
                                <div class="flex items-center">
                        <span class="font-semibold">‚è±Ô∏è Cooking Time:</span>
                                    <span id="cooking-time" class="ml-2"></span>
                                </div>
                                <div class="flex items-center">
                        <span class="font-semibold">üë• Servings:</span>
                                    <span id="servings" class="ml-2"></span>
                                </div>
                                <div class="flex items-center">
                        <span class="font-semibold">üî• Calories:</span>
                                    <span id="calories" class="ml-2"></span>
                                </div>
                            </div>
                
                <!-- Action Buttons -->
                <div class="flex gap-4">
                    <button onclick="generateNewRecipe()" class="btn-primary px-6 py-2">
                        üîÑ Generate New Recipe
                    </button>
                    <button onclick="saveRecipe()" class="btn-primary px-6 py-2">
                        üíæ Save Recipe
                    </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Premium Modal -->
        <div id="premium-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="card p-8 max-w-md w-full">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Upgrade to Premium</h2>
                    <p class="text-gray-600 mb-6">Get unlimited recipes and advanced features!</p>
                    
                    <div class="space-y-4 mb-6">
                        <div class="flex items-center justify-between p-4 border rounded-lg">
                                    <div>
                                <h3 class="font-semibold">Monthly Plan</h3>
                                <p class="text-sm text-gray-600">$9.99/month</p>
                                    </div>
                            <button onclick="selectPlan('monthly')" class="btn-primary px-4 py-2">
                                Choose Monthly
                                    </button>
                            </div>
                            
                        <div class="flex items-center justify-between p-4 border rounded-lg bg-yellow-50">
                                    <div>
                                <h3 class="font-semibold">Yearly Plan</h3>
                                <p class="text-sm text-gray-600">$79.99/year (Save 33%)</p>
                                    </div>
                            <button onclick="selectPlan('yearly')" class="btn-primary px-4 py-2">
                                Choose Yearly
                                    </button>
                                </div>
                            </div>
                    
                    <button onclick="closePremiumModal()" class="text-gray-500 hover:text-gray-700">
                        Cancel
                    </button>
                </div>
                    </div>
                    </div>
                    
        <!-- Payment Form -->
        <div id="payment-form" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="card p-8 max-w-md w-full">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Complete Payment</h2>
                    <div id="plan-details" class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <p class="text-sm text-gray-600">You're subscribing to: <span id="selected-plan-text" class="font-semibold">Monthly Plan</span></p>
                        <p class="text-sm text-gray-600">Amount: <span id="selected-plan-price" class="font-semibold">$9.99/month</span></p>
                        <p class="text-xs text-blue-600 mt-1">Secure payment processing</p>
                        <p class="text-xs text-green-600 mt-1">‚úÖ Live Stripe payment processing</p>
                    </div>
                    <p class="text-gray-600 mb-6">Enter your payment details to upgrade to premium.</p>
                    
                    <form id="payment-form-element">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">Email Address:</label>
                            <input type="email" id="email" class="input-field" required placeholder="your@email.com">
                            <p class="text-xs text-gray-500 mt-1">We'll send your receipt to this email</p>
                    </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">Postal Code:</label>
                            <input type="text" id="postal-code" class="input-field" required placeholder="12345">
                            <p class="text-xs text-gray-500 mt-1">For billing verification</p>
                    </div>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 font-semibold mb-2">Card Details:</label>
                            <div id="card-element" class="input-field p-3"></div>
                            <div id="card-errors" class="text-red-500 text-sm mt-2"></div>
                            <p class="text-xs text-gray-500 mt-1">Your payment is secure and encrypted</p>
                                    </div>
                                    
                        <button type="submit" class="btn-primary w-full py-3">
                            Subscribe Now
                        </button>
                    </form>
                    
                    <button onclick="closePaymentForm()" class="text-gray-500 hover:text-gray-700 mt-4">
                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>

    <script>
        let ingredientCount = 1;
        let isPremium = false;
        let selectedPlan = '';

        // Initialize Stripe with live keys for real payments
        let stripe, elements, cardElement;
        try {
            // Use live Stripe keys for real payments
            stripe = Stripe('pk_live_51QGR3EDYRm11DoRiF412084WDjELauYMAvVDQ3W1pHL05fLavgUQeUm9MwrtDhRLEeRTB3NfnqHAwHtt2vf0MTVp00QRkSfv5x');
            elements = stripe.elements();
            cardElement = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#424770',
                        '::placeholder': {
                            color: '#aab7c4',
                        },
                    },
                    invalid: {
                        color: '#9e2146',
                    },
                },
            });
            cardElement.mount('#card-element');
        } catch (error) {
            console.log('Stripe initialization failed:', error);
        }

        // Check if user is premium on page load
        window.addEventListener('load', function() {
            console.log('Page loaded, checking premium status...');
            const premiumStatus = localStorage.getItem('isPremium');
            console.log('Premium status from localStorage:', premiumStatus);
            
            if (premiumStatus === 'true') {
                isPremium = true;
                console.log('User is premium, hiding banner and showing features');
                // Hide the premium banner and show premium features
                const banner = document.getElementById('premium-banner');
                if (banner) {
                    banner.classList.add('hidden');
                }
                // Add premium features to the form
                showPremiumFeatures();
            } else {
                // Ensure premium features are hidden if not paid
                isPremium = false;
                console.log('User is NOT premium, showing banner and hiding features');
                const premiumFeatures = document.getElementById('premium-features');
                if (premiumFeatures) {
                    premiumFeatures.classList.add('hidden');
                }
                // Show premium banner if not paid
                const banner = document.getElementById('premium-banner');
                if (banner) {
                    banner.classList.remove('hidden');
                    console.log('Premium banner should be visible now');
            } else {
                    console.error('Premium banner element not found!');
                }
            }
        });

        function addIngredient() {
            const container = document.getElementById('ingredients-container');
            const newDiv = document.createElement('div');
            newDiv.className = 'flex gap-2 mb-2';
            newDiv.innerHTML = `
                <input type="text" class="input-field flex-1" placeholder="Enter an ingredient..." id="ingredient-${ingredientCount}">
                <button onclick="addIngredient()" class="btn-primary">+</button>
                <button onclick="removeIngredient(this)" class="btn-primary">-</button>
            `;
            container.appendChild(newDiv);
            ingredientCount++;
        }

        function removeIngredient(button) {
            button.parentElement.remove();
        }

        function generateRecipe() {
            const ingredients = [];
            for (let i = 0; i < ingredientCount; i++) {
                const input = document.getElementById(`ingredient-${i}`);
                if (input && input.value.trim()) {
                    ingredients.push(input.value.trim());
                }
            }

            if (ingredients.length === 0) {
                alert('Please add at least one ingredient!');
                return;
            }

            // Get dietary restrictions
            const restrictions = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                restrictions.push(cb.value);
            });

            // Check if user has premium access for advanced features
            let premiumSettings = {};
            if (isPremium && checkPaymentStatus()) {
                console.log('User has premium access, using advanced features');
                premiumSettings = {
                    servings: document.getElementById('servings-select').value,
                    cookingTime: document.getElementById('time-select').value,
                    cuisine: document.getElementById('cuisine-select').value,
                    difficulty: document.getElementById('difficulty-select').value,
                    method: document.getElementById('method-select').value,
                    spice: document.getElementById('spice-select').value,
                    nutrition: document.getElementById('nutrition-select').value,
                    budget: document.getElementById('budget-select').value
                };
            } else {
                console.log('User does not have premium access, using basic features');
                // Show upgrade prompt if they try to use premium features
                const servingsSelect = document.getElementById('servings-select');
                const timeSelect = document.getElementById('time-select');
                const cuisineSelect = document.getElementById('cuisine-select');
                const difficultySelect = document.getElementById('difficulty-select');
                
                if (servingsSelect && servingsSelect.value !== '4' || 
                    timeSelect && timeSelect.value !== 'any' ||
                    cuisineSelect && cuisineSelect.value !== 'any' ||
                    difficultySelect && difficultySelect.value !== 'any') {
                    alert('Premium features require payment. Please upgrade to access advanced options!');
                    return;
                }
            }

            // Generate recipe
            const recipe = generateRecipeFromIngredients(ingredients, restrictions, premiumSettings);
            displayRecipe(recipe);
        }

        function generateRecipeFromIngredients(ingredients, restrictions, premiumSettings = {}) {
            const recipeTitle = generateRecipeTitle(ingredients, premiumSettings.cuisine);
            const recipeDescription = generateRecipeDescription(ingredients, premiumSettings.cuisine, premiumSettings);
            
            // Scale ingredients based on servings
            const servings = parseInt(premiumSettings.servings) || 4;
            const scaleFactor = servings / 4;
            
            // Generate ingredients list
            const recipeIngredients = ingredients.map(ingredient => {
                const amount = estimateIngredientAmount(ingredient, servings);
                return {
                    item: ingredient,
                    amount: amount.amount,
                    unit: amount.unit
                };
            });
            
            // Add common complementary ingredients based on cuisine and premium settings
            const complementaryIngredients = getComplementaryIngredients(ingredients, premiumSettings.cuisine, premiumSettings);
            recipeIngredients.push(...complementaryIngredients);
            
            // Generate cooking instructions based on all premium settings
            const instructions = generateCookingInstructions(ingredients, premiumSettings.cuisine, premiumSettings.difficulty, premiumSettings.method, premiumSettings.spice);
            
            // Calculate cooking time and calories based on premium settings
            const cookingTime = calculateCookingTime(ingredients, premiumSettings.cookingTime, premiumSettings.method);
            const calories = estimateCalories(recipeIngredients, premiumSettings.nutrition);
            
            // Add premium information to the recipe
            const premiumInfo = {
                cuisine: premiumSettings.cuisine || 'any',
                difficulty: premiumSettings.difficulty || 'any',
                method: premiumSettings.method || 'any',
                spice: premiumSettings.spice || 'any',
                nutrition: premiumSettings.nutrition || 'any',
                budget: premiumSettings.budget || 'any'
            };
            
            return {
                title: recipeTitle,
                description: recipeDescription,
                ingredients: recipeIngredients,
                instructions: instructions,
                cookingTime: cookingTime,
                servings: servings,
                calories: calories,
                premiumInfo: premiumInfo
            };
        }

        function generateRecipeTitle(ingredients, cuisine) {
            const mainIngredient = ingredients[0];
            const cuisineName = cuisine === 'any' ? '' : cuisine;
            return `${cuisineName.charAt(0).toUpperCase() + cuisineName.slice(1)} ${mainIngredient.charAt(0).toUpperCase() + mainIngredient.slice(1)} Recipe`;
        }

        function generateRecipeDescription(ingredients, cuisine, premiumSettings) {
            const cuisineName = cuisine === 'any' ? '' : cuisine + ' ';
            const method = premiumSettings.method === 'any' ? '' : premiumSettings.method + ' ';
            const spice = premiumSettings.spice === 'any' ? '' : premiumSettings.spice + ' ';
            const nutrition = premiumSettings.nutrition === 'any' ? '' : premiumSettings.nutrition + ' ';
            const budget = premiumSettings.budget === 'any' ? '' : premiumSettings.budget + ' ';

            return `A delicious ${cuisineName}${method}${spice}${nutrition}${budget}recipe featuring ${ingredients.join(', ')}. Perfect for any occasion!`;
        }

        function estimateIngredientAmount(ingredient, servings) {
            const scaleFactor = servings / 4;
            
            const amounts = {
                'chicken': { amount: 2 * scaleFactor, unit: 'lbs' },
                'beef': { amount: 1.5 * scaleFactor, unit: 'lbs' },
                'salmon': { amount: 1 * scaleFactor, unit: 'lb' },
                'pasta': { amount: 1 * scaleFactor, unit: 'lb' },
                'rice': { amount: 2 * scaleFactor, unit: 'cups' },
                'tomatoes': { amount: 4 * scaleFactor, unit: 'medium' },
                'onions': { amount: 2 * scaleFactor, unit: 'medium' },
                'garlic': { amount: 4 * scaleFactor, unit: 'cloves' },
                'carrots': { amount: 3 * scaleFactor, unit: 'medium' },
                'potatoes': { amount: 4 * scaleFactor, unit: 'medium' },
                'broccoli': { amount: 2 * scaleFactor, unit: 'cups' },
                'spinach': { amount: 3 * scaleFactor, unit: 'cups' },
                'mushrooms': { amount: 8 * scaleFactor, unit: 'oz' },
                'bell peppers': { amount: 2 * scaleFactor, unit: 'medium' },
                'cheese': { amount: 2 * scaleFactor, unit: 'cups' },
                'milk': { amount: 2 * scaleFactor, unit: 'cups' },
                'butter': { amount: 4 * scaleFactor, unit: 'tbsp' },
                'oil': { amount: 3 * scaleFactor, unit: 'tbsp' }
            };
            
            for (const [key, value] of Object.entries(amounts)) {
                if (ingredient.toLowerCase().includes(key)) {
                    return value;
                }
            }
            
            return { amount: 1 * scaleFactor, unit: 'cup' };
        }

        function getComplementaryIngredients(ingredients, cuisine, premiumSettings) {
            const complementary = [];
            complementary.push({ item: 'olive oil', amount: 2, unit: 'tbsp' });
            complementary.push({ item: 'salt', amount: 1, unit: 'tsp' });
            complementary.push({ item: 'black pepper', amount: 1, unit: 'tsp' });
            
            // Add spices based on spice level
            if (premiumSettings.spice === 'mild') {
                complementary.push({ item: 'paprika', amount: 1, unit: 'tsp' });
            } else if (premiumSettings.spice === 'medium') {
                complementary.push({ item: 'chili powder', amount: 1, unit: 'tsp' });
                complementary.push({ item: 'cayenne pepper', amount: 1/2, unit: 'tsp' });
            } else if (premiumSettings.spice === 'hot') {
                complementary.push({ item: 'hot sauce', amount: 2, unit: 'tbsp' });
                complementary.push({ item: 'jalape√±o', amount: 2, unit: 'pieces' });
            } else if (premiumSettings.spice === 'extra-hot') {
                complementary.push({ item: 'habanero pepper', amount: 1, unit: 'piece' });
                complementary.push({ item: 'ghost pepper sauce', amount: 1, unit: 'tsp' });
            }
            
            // Add ingredients based on cuisine
            if (cuisine === 'italian') {
                complementary.push({ item: 'garlic', amount: 3, unit: 'cloves' });
                complementary.push({ item: 'basil', amount: 1/4, unit: 'cup' });
                complementary.push({ item: 'parmesan cheese', amount: 1/2, unit: 'cup' });
            } else if (cuisine === 'asian') {
                complementary.push({ item: 'ginger', amount: 1, unit: 'tbsp' });
                complementary.push({ item: 'soy sauce', amount: 3, unit: 'tbsp' });
                complementary.push({ item: 'sesame oil', amount: 1, unit: 'tbsp' });
            } else if (cuisine === 'mexican') {
                complementary.push({ item: 'lime', amount: 2, unit: 'pieces' });
                complementary.push({ item: 'cilantro', amount: 1/4, unit: 'cup' });
                complementary.push({ item: 'cumin', amount: 1, unit: 'tsp' });
            } else if (cuisine === 'thai') {
                complementary.push({ item: 'fish sauce', amount: 2, unit: 'tbsp' });
                complementary.push({ item: 'lemongrass', amount: 2, unit: 'stalks' });
                complementary.push({ item: 'coconut milk', amount: 1, unit: 'can' });
            } else if (cuisine === 'indian') {
                complementary.push({ item: 'turmeric', amount: 1, unit: 'tsp' });
                complementary.push({ item: 'cumin', amount: 1, unit: 'tsp' });
                complementary.push({ item: 'coriander', amount: 1, unit: 'tsp' });
            } else {
                complementary.push({ item: 'garlic', amount: 3, unit: 'cloves' });
            }
            
            // Add ingredients based on nutrition focus
            if (premiumSettings.nutrition === 'low-calorie') {
                complementary.push({ item: 'vegetable broth', amount: 1, unit: 'cup' });
            } else if (premiumSettings.nutrition === 'high-protein') {
                complementary.push({ item: 'protein powder', amount: 1, unit: 'scoop' });
            } else if (premiumSettings.nutrition === 'keto') {
                complementary.push({ item: 'butter', amount: 2, unit: 'tbsp' });
                complementary.push({ item: 'heavy cream', amount: 1/2, unit: 'cup' });
            }
            
            return complementary;
        }

        function generateCookingInstructions(ingredients, cuisine, difficulty, method, spice) {
            const instructions = [];
            instructions.push(`Prepare and chop all ingredients: ${ingredients.join(', ')}.`);
            
            // Add cooking method specific instructions
            if (method === 'stovetop') {
                instructions.push('Heat oil in a large pan or skillet over medium heat.');
            } else if (method === 'oven') {
                instructions.push('Preheat oven to 375¬∞F (190¬∞C).');
                instructions.push('Grease a baking dish with oil or butter.');
            } else if (method === 'grill') {
                instructions.push('Preheat grill to medium-high heat.');
                instructions.push('Oil the grill grates to prevent sticking.');
            } else if (method === 'slow-cooker') {
                instructions.push('Add ingredients to slow cooker.');
                instructions.push('Set to LOW for 6-8 hours or HIGH for 3-4 hours.');
            } else if (method === 'instant-pot') {
                instructions.push('Set Instant Pot to SAUT√â mode.');
                instructions.push('Add oil and heat until hot.');
            } else if (method === 'air-fryer') {
                instructions.push('Preheat air fryer to 375¬∞F (190¬∞C).');
                instructions.push('Lightly oil the air fryer basket.');
            } else if (method === 'microwave') {
                instructions.push('Place ingredients in a microwave-safe dish.');
                instructions.push('Cover with microwave-safe lid or plastic wrap.');
            } else if (method === 'raw') {
                instructions.push('No cooking required - this is a raw recipe.');
            } else {
                instructions.push('Heat oil in a large pan or skillet over medium heat.');
            }
            
            // Add cuisine-specific instructions
            if (cuisine === 'italian') {
                instructions.push('Add garlic and saut√© until fragrant, about 1 minute.');
                instructions.push('Add main ingredients and cook until tender.');
                instructions.push('Season with salt, pepper, and herbs.');
                instructions.push('Garnish with fresh basil and parmesan cheese.');
            } else if (cuisine === 'asian') {
                instructions.push('Add ginger and garlic, stir-fry for 30 seconds.');
                instructions.push('Add main ingredients and stir-fry for 3-5 minutes.');
                instructions.push('Add soy sauce and sesame oil, toss to combine.');
                instructions.push('Garnish with green onions and serve hot.');
            } else if (cuisine === 'mexican') {
                instructions.push('Add onions and cook until softened.');
                instructions.push('Add main ingredients and cook until tender.');
                instructions.push('Season with cumin, salt, and pepper.');
                instructions.push('Garnish with cilantro and lime wedges.');
            } else if (cuisine === 'thai') {
                instructions.push('Add lemongrass and garlic, stir-fry for 30 seconds.');
                instructions.push('Add main ingredients and stir-fry for 3-5 minutes.');
                instructions.push('Add fish sauce and coconut milk, simmer for 5 minutes.');
                instructions.push('Garnish with fresh herbs and serve hot.');
            } else if (cuisine === 'indian') {
                instructions.push('Add spices and saut√© until fragrant, about 1 minute.');
                instructions.push('Add main ingredients and cook until tender.');
                instructions.push('Season with turmeric, cumin, and coriander.');
                instructions.push('Garnish with fresh cilantro and serve hot.');
            } else {
                instructions.push('Add garlic and saut√© until fragrant, about 1 minute.');
                instructions.push('Add main ingredients and cook until tender.');
                instructions.push('Season with salt and pepper to taste.');
                instructions.push('Cook until all ingredients are well combined.');
            }
            
            // Add spice level instructions
            if (spice === 'mild') {
                instructions.push('Add mild spices and seasonings to taste.');
            } else if (spice === 'medium') {
                instructions.push('Add medium heat spices and adjust to taste.');
            } else if (spice === 'hot') {
                instructions.push('Add hot spices and peppers - be careful with heat!');
            } else if (spice === 'extra-hot') {
                instructions.push('Add extra hot spices - this will be very spicy!');
            }
            
            // Add difficulty-specific instructions
            if (difficulty === 'easy') {
                instructions.push('This is a simple recipe perfect for beginners.');
            } else if (difficulty === 'medium') {
                instructions.push('This recipe requires some cooking experience.');
            } else if (difficulty === 'hard') {
                instructions.push('This is an advanced recipe with complex techniques.');
            } else if (difficulty === 'expert') {
                instructions.push('This is a chef-level recipe with advanced techniques.');
            }
            
            instructions.push('Serve hot and enjoy!');
            
            return instructions;
        }

        function calculateCookingTime(ingredients, timePreference, method) {
            let baseTime = 20;
            const ingredientTime = ingredients.length * 5;
            
            // Adjust time based on cooking method
            if (method === 'slow-cooker') {
                baseTime = 240; // 4 hours minimum
            } else if (method === 'oven') {
                baseTime = 45; // Baking takes longer
            } else if (method === 'grill') {
                baseTime = 30; // Grilling takes medium time
            } else if (method === 'instant-pot') {
                baseTime = 15; // Pressure cooking is faster
            } else if (method === 'air-fryer') {
                baseTime = 25; // Air frying is medium-fast
            } else if (method === 'microwave') {
                baseTime = 10; // Microwave is fastest
            } else if (method === 'raw') {
                baseTime = 5; // Raw recipes are instant
            }
            
            const totalTime = baseTime + ingredientTime;
            
            if (timePreference === 'quick') {
                return Math.min(totalTime, 15) + ' minutes';
            } else if (timePreference === 'medium') {
                return Math.min(totalTime, 30) + ' minutes';
            } else if (timePreference === 'slow') {
                return Math.max(totalTime, 30) + ' minutes';
            } else if (timePreference === 'overnight') {
                return '6-8 hours (overnight)';
            }
            
            return totalTime + ' minutes';
        }

        function estimateCalories(ingredients, nutrition) {
            let totalCalories = 0;
            ingredients.forEach(ingredient => {
                const item = ingredient.item.toLowerCase();
                const amount = parseFloat(ingredient.amount);
                
                const caloriesPerUnit = {
                    'chicken': 165, 'beef': 250, 'salmon': 208, 'pasta': 131,
                    'rice': 130, 'tomatoes': 22, 'onions': 44, 'garlic': 4,
                    'carrots': 25, 'potatoes': 77, 'broccoli': 31, 'spinach': 7,
                    'mushrooms': 15, 'bell peppers': 30, 'cheese': 113,
                    'milk': 103, 'butter': 102, 'oil': 120
                };
                
                for (const [key, calories] of Object.entries(caloriesPerUnit)) {
                    if (item.includes(key)) {
                        totalCalories += calories * amount;
                        break;
                    }
                }
            });
            
            // Adjust calories based on nutrition focus
            if (nutrition === 'low-calorie') {
                totalCalories = Math.round(totalCalories * 0.7); // 30% reduction
            } else if (nutrition === 'high-protein') {
                totalCalories = Math.round(totalCalories * 1.2); // 20% increase for protein
            } else if (nutrition === 'keto') {
                totalCalories = Math.round(totalCalories * 1.3); // 30% increase for fats
            } else if (nutrition === 'paleo') {
                totalCalories = Math.round(totalCalories * 1.1); // 10% increase
            } else if (nutrition === 'heart-healthy') {
                totalCalories = Math.round(totalCalories * 0.9); // 10% reduction
            }
            
            return totalCalories;
        }

        function displayRecipe(recipe) {
            document.getElementById('recipe-title').textContent = recipe.title;
            document.getElementById('recipe-description').textContent = recipe.description;
            document.getElementById('cooking-time').textContent = recipe.cookingTime;
            document.getElementById('servings').textContent = recipe.servings;
            document.getElementById('calories').textContent = recipe.calories;
            
            // Display ingredients
            const ingredientsList = document.getElementById('recipe-ingredients');
            ingredientsList.innerHTML = '';
            recipe.ingredients.forEach(ingredient => {
                const li = document.createElement('li');
                li.textContent = `${ingredient.amount} ${ingredient.unit} ${ingredient.item}`;
                ingredientsList.appendChild(li);
            });

            // Display instructions
            const instructionsList = document.getElementById('recipe-instructions');
            instructionsList.innerHTML = '';
            recipe.instructions.forEach((instruction, index) => {
                const li = document.createElement('li');
                li.textContent = instruction;
                instructionsList.appendChild(li);
            });

            document.getElementById('recipe-display').classList.remove('hidden');
            window.currentRecipe = recipe;
        }

        function generateNewRecipe() {
            generateRecipe();
        }

        function saveRecipe() {
            if (window.currentRecipe) {
            const savedRecipes = JSON.parse(localStorage.getItem('savedRecipes') || '[]');
                savedRecipes.push(window.currentRecipe);
                localStorage.setItem('savedRecipes', JSON.stringify(savedRecipes));
                alert('Recipe saved successfully!');
                } else {
                alert('No recipe to save. Generate a recipe first!');
            }
        }

        // Premium functions
        function showPremiumModal() {
            console.log('Upgrade button clicked!');
            const modal = document.getElementById('premium-modal');
            if (modal) {
                modal.classList.remove('hidden');
                console.log('Premium modal shown successfully');
            } else {
                console.error('Premium modal not found!');
                alert('Modal not found!');
            }
        }

        function closePremiumModal() {
            document.getElementById('premium-modal').classList.add('hidden');
        }

        function selectPlan(plan) {
            console.log('Plan selected:', plan);
            selectedPlan = plan;
            document.getElementById('premium-modal').classList.add('hidden');
            document.getElementById('payment-form').classList.remove('hidden');
            console.log('Payment form opened');

            const planDetails = document.getElementById('plan-details');
            const selectedPlanText = document.getElementById('selected-plan-text');
            const selectedPlanPrice = document.getElementById('selected-plan-price');

            if (plan === 'monthly') {
                selectedPlanText.textContent = 'Monthly Plan';
                selectedPlanPrice.textContent = '$9.99/month';
            } else if (plan === 'yearly') {
                selectedPlanText.textContent = 'Yearly Plan';
                selectedPlanPrice.textContent = '$79.99/year (Save 33%)';
            }
        }

        function closePaymentForm() {
            document.getElementById('payment-form').classList.add('hidden');
            // Reset form
            document.getElementById('payment-form-element').reset();
            document.getElementById('card-errors').textContent = '';
        }

        // Handle payment form submission
        document.getElementById('payment-form-element').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const postalCode = document.getElementById('postal-code').value;
            
            // Clear previous errors
            document.getElementById('card-errors').textContent = '';
            
            // Validate inputs
            if (!email || !postalCode) {
                alert('Please fill in all required fields.');
                    return;
                }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address.');
                return;
            }
            
            // Validate postal code
            if (postalCode.length < 3) {
                alert('Please enter a valid postal code.');
                return;
            }
            
            console.log('Processing payment for:', email, 'Plan:', selectedPlan);
            
            try {
                // Show processing message
                const submitButton = document.querySelector('#payment-form-element button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.textContent = 'Processing Real Payment...';
                submitButton.disabled = true;
                
                // Create payment method with Stripe for real payment
                const result = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                    billing_details: {
                        email: email,
                        address: {
                            postal_code: postalCode,
                        },
                    },
                });

                if (result.error) {
                    document.getElementById('card-errors').textContent = result.error.message;
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                    return;
                }
                
                console.log('Payment method created successfully');
                console.log('Payment Method ID:', result.paymentMethod.id);
                
                // Process REAL payment with actual charges
                console.log('Processing REAL payment with actual charges...');
                
                // Create a real charge using the payment method
                const amount = selectedPlan === 'monthly' ? 999 : 7999; // $9.99 or $79.99 in cents
                
                // Create payment intent on the backend
                const paymentIntentResponse = await fetch('/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: amount,
                        currency: 'usd',
                        email: email,
                        plan: selectedPlan
                    })
                });
                
                if (!paymentIntentResponse.ok) {
                    throw new Error('Failed to create payment intent');
                }
                
                const paymentIntentData = await paymentIntentResponse.json();
                console.log('Payment intent created:', paymentIntentData);
                
                // Confirm the payment with the backend
                const confirmResponse = await fetch('/confirm-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        paymentIntentId: paymentIntentData.paymentIntentId,
                        paymentMethodId: result.paymentMethod.id
                    })
                });
                
                if (!confirmResponse.ok) {
                    throw new Error('Failed to confirm payment');
                }
                
                const confirmData = await confirmResponse.json();
                console.log('Payment confirmed:', confirmData);
                
                // Set premium status after successful REAL payment
                isPremium = true;
                localStorage.setItem('isPremium', 'true');
                
                // Hide premium banner
                const banner = document.getElementById('premium-banner');
                if (banner) {
                    banner.classList.add('hidden');
                }
                
                // Close payment form
                closePaymentForm();
                
                // Reset button
                submitButton.textContent = originalText;
                submitButton.disabled = false;
                
                // Show success message for REAL payment
                const planText = selectedPlan === 'monthly' ? 'Monthly ($9.99/month)' : 'Yearly ($79.99/year)';
                const displayAmount = selectedPlan === 'monthly' ? 9.99 : 79.99;
                alert(`REAL payment successful! Your card has been charged $${displayAmount} for ${planText}.\nYou now have premium access!`);
                
                // Show premium features immediately
                showPremiumFeatures();
                
                // Force refresh the page to show premium features
            setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('REAL payment error:', error);
                const errorMessage = 'REAL payment failed. Please check your card details and try again.';
                document.getElementById('card-errors').textContent = errorMessage;
                
                // Reset button
                const submitButton = document.querySelector('#payment-form-element button[type="submit"]');
                submitButton.textContent = 'Subscribe Now';
                submitButton.disabled = false;
            }
        });

        function showPremiumFeatures() {
            console.log('Showing premium features...');
            const premiumFeatures = document.getElementById('premium-features');
            if (premiumFeatures) {
                premiumFeatures.classList.remove('hidden');
                console.log('Premium features are now visible');
            } else {
                console.error('Premium features element not found');
            }
        }

        // Function to reset premium status (for testing)
        function resetPremium() {
            isPremium = false;
            localStorage.removeItem('isPremium');
            const banner = document.getElementById('premium-banner');
            if (banner) {
                banner.classList.remove('hidden');
            }
            const premiumFeatures = document.getElementById('premium-features');
            if (premiumFeatures) {
                premiumFeatures.classList.add('hidden');
            }
            alert('Premium status reset for testing!');
        }

        // Function to clear all premium access and force payment
        function clearAllPremiumAccess() {
            isPremium = false;
            localStorage.removeItem('isPremium');
            localStorage.removeItem('savedRecipes');
            
            // Hide premium features
            const premiumFeatures = document.getElementById('premium-features');
            if (premiumFeatures) {
                premiumFeatures.classList.add('hidden');
            }
            
            // Show premium banner
            const banner = document.getElementById('premium-banner');
            if (banner) {
                banner.classList.remove('hidden');
            }
            
            // Hide recipe display
            const recipeDisplay = document.getElementById('recipe-display');
            if (recipeDisplay) {
                recipeDisplay.classList.add('hidden');
            }
            
            alert('All premium access cleared. Users must pay to access premium features.');
        }

        // Function to check if user has actually paid
        function checkPaymentStatus() {
            const premiumStatus = localStorage.getItem('isPremium');
            if (premiumStatus !== 'true') {
                // Force hide premium features if not paid
                isPremium = false;
                const premiumFeatures = document.getElementById('premium-features');
                if (premiumFeatures) {
                    premiumFeatures.classList.add('hidden');
                }
                // Show premium banner
                const banner = document.getElementById('premium-banner');
                if (banner) {
                    banner.classList.remove('hidden');
                }
                return false;
            }
            return true;
        }

        // Function to test the premium modal
        function testPremiumModal() {
            console.log('Test button clicked!');
            showPremiumModal();
        }

        // Function to unlock premium features for testing
        function unlockPremiumForTesting() {
            console.log('Unlocking premium features for testing...');
            isPremium = true;
            localStorage.setItem('isPremium', 'true');
            const banner = document.getElementById('premium-banner');
            if (banner) {
                banner.classList.add('hidden');
            }
            const premiumFeatures = document.getElementById('premium-features');
            if (premiumFeatures) {
                premiumFeatures.classList.remove('hidden');
            }
            alert('Premium features unlocked for testing!');
        }

        // Function to test the payment process
        function testPayment() {
            console.log('Testing payment process...');
            // Simulate a successful payment for testing
            isPremium = true;
            localStorage.setItem('isPremium', 'true');
            const banner = document.getElementById('premium-banner');
            if (banner) {
                banner.classList.add('hidden');
            }
            const premiumFeatures = document.getElementById('premium-features');
            if (premiumFeatures) {
                premiumFeatures.classList.remove('hidden');
            }
            alert('Payment process simulated for testing!');
        }
    </script>
</body>
</html> 